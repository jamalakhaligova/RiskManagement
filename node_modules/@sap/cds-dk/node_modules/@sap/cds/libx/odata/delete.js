const cds = require('../../')
const { odataError } = require('./utils')

module.exports = srv =>
  function deleete(req, res, next) {
    const query = cds.odata.parse(req.url, { service: srv, baseUrl: req.baseUrl })

    let {
      SELECT: { one }
    } = query

    if (!one) {
      return res.status(405).json(odataError('405', `Method DELETE not allowed for ENTITY.COLLECTION`))
    }

    const _target = query.SELECT && query.SELECT.from
    const deleteQuery = DELETE.from(_target)

    return srv
      .run(deleteQuery)
      .then(() => {
        return res.send(204)
      })
      .catch(next)
  }
