const { join } = require('path')
const { exists, copy } = require('../../../cds').utils
const { readProject } = require('../../projectReader')
const { merge } = require('../../merge')

module.exports = class Html5RepoTemplate extends require('../../plugin') {

    requires() {
        return ['destination']
    }

    async canRun() {
        const project = readProject()
        const { hasMta, hasHelm, hasHelmUnifiedRuntime } = project
        if (!(hasHelm || hasHelmUnifiedRuntime) && hasMta) {
            throw `'cds add html5-repo' is not available for Cloud Foundry yet`
        }
        return true
    }

    static hasInProduction() {
        // REVISIT: Should be detectable without helm charts
        return exists(join('chart', 'templates', 'html5-apps-deployer-configmap.yaml'))
    }

    async combine() {
        const project = readProject()
        const { hasHelm, hasHelmUnifiedRuntime } = project
        if (hasHelm || hasHelmUnifiedRuntime) {
            await merge(__dirname, 'files/values.yaml.hbs').into('chart/values.yaml', { with: project })
            await merge({
                'html5-apps-deployer': {
                    envFrom: [{
                        configMapRef: {
                            name: '{{ .Release.Name }}-html5-apps-deployer-configmap'
                        }
                    }]
                }
            }).into('chart/values.yaml')
            await copy(join(__dirname, 'files', 'html5-apps-deployer-configmap.yaml')).to('chart', 'templates', 'html5-apps-deployer-configmap.yaml')
        }
    }
}
